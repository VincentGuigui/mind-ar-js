<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Frame Mode Test - 4 Separate Values</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .test-section {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
            flex: 1;
        }
        h2 {
            color: #333;
            margin-top: 0;
        }
        .result {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .canvas-container {
            margin: 10px 0;
        }
        canvas {
            border: 1px solid #ddd;
            max-width: 100%;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196f3;
            margin: 20px 0;
        }
        .controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .slider-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 80px;
            font-weight: bold;
        }
        input[type="range"] {
            width: 200px;
        }
        .value-display {
            display: inline-block;
            width: 50px;
            text-align: right;
        }
    </style>
</head>
<body>
    <h1>Frame-Only Feature Detection Test - 4 Separate Values</h1>
    
    <div class="info">
        <strong>What's New:</strong><br>
        The frame thickness can now be specified separately for each side (top, right, bottom, left) as percentages of image dimensions:
        <ul>
            <li><strong>top/bottom</strong>: percentage of image height</li>
            <li><strong>left/right</strong>: percentage of image width</li>
        </ul>
        This allows for asymmetric frame detection, perfect for cards with borders of different widths.
    </div>

    <div class="container">
        <div class="test-section">
            <h2>Normal Mode</h2>
            <p>Features extracted from entire image</p>
            <div class="canvas-container">
                <canvas id="normalCanvas" width="400" height="300"></canvas>
            </div>
            <button onclick="runNormalTest()">Run Normal Mode Test</button>
            <div class="result" id="normalResult">Click button to run test</div>
        </div>

        <div class="test-section">
            <h2>Frame-Only Mode (Uniform)</h2>
            <p>Features extracted with same thickness on all sides (10%)</p>
            <div class="canvas-container">
                <canvas id="frameCanvas" width="400" height="300"></canvas>
            </div>
            <button onclick="runFrameTest()">Run Uniform Frame Test</button>
            <div class="result" id="frameResult">Click button to run test</div>
        </div>
    </div>

    <div class="test-section">
        <h2>Custom Frame Configuration</h2>
        <p>Adjust each side independently:</p>
        <div class="controls">
            <div class="slider-group">
                <label>Top:</label>
                <input type="range" id="topSlider" min="0" max="0.3" step="0.05" value="0.15" onchange="updateDisplay()">
                <span class="value-display" id="topValue">0.15</span> (15%)
            </div>
            <div class="slider-group">
                <label>Right:</label>
                <input type="range" id="rightSlider" min="0" max="0.3" step="0.05" value="0.05" onchange="updateDisplay()">
                <span class="value-display" id="rightValue">0.05</span> (5%)
            </div>
            <div class="slider-group">
                <label>Bottom:</label>
                <input type="range" id="bottomSlider" min="0" max="0.3" step="0.05" value="0.20" onchange="updateDisplay()">
                <span class="value-display" id="bottomValue">0.20</span> (20%)
            </div>
            <div class="slider-group">
                <label>Left:</label>
                <input type="range" id="leftSlider" min="0" max="0.3" step="0.05" value="0.10" onchange="updateDisplay()">
                <span class="value-display" id="leftValue">0.10</span> (10%)
            </div>
        </div>
        <button onclick="runCustomTest()">Test Custom Configuration</button>
        <div class="canvas-container">
            <canvas id="customCanvas" width="400" height="300"></canvas>
        </div>
        <div class="result" id="customResult">Adjust sliders and click test</div>
    </div>

    <script type="module">
        // Import the extract function to test it directly
        import { extract } from '../src/image-target/tracker/extract.js';
        
        // Make functions available globally for buttons
        window.extract = extract;
        
        // Test image data - simple pattern with border and inner content
        function createTestImageData(width, height) {
            const data = new Uint8Array(width * height);
            
            // Fill with gradient pattern
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const pos = y * width + x;
                    // Create a pattern with more features near borders
                    const borderDist = Math.min(x, y, width - x - 1, height - y - 1);
                    const centerDist = Math.sqrt((x - width/2)**2 + (y - height/2)**2);
                    
                    // Border gets high contrast patterns
                    if (borderDist < 30) {
                        data[pos] = ((x + y) % 20 < 10) ? 255 : 0;
                    } else {
                        // Inner area gets lower contrast
                        data[pos] = 128 + Math.sin(centerDist * 0.1) * 50;
                    }
                }
            }
            
            return data;
        }

        function drawImageWithFeatures(canvasId, imageData, width, height, features, title) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw image
            const imgData = ctx.createImageData(width, height);
            for (let i = 0; i < imageData.length; i++) {
                const val = imageData[i];
                imgData.data[i * 4] = val;     // R
                imgData.data[i * 4 + 1] = val; // G
                imgData.data[i * 4 + 2] = val; // B
                imgData.data[i * 4 + 3] = 255; // A
            }
            
            // Scale to canvas size
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = width;
            tempCanvas.height = height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.putImageData(imgData, 0, 0);
            
            ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
            
            // Draw feature points
            ctx.fillStyle = 'red';
            const scaleX = canvas.width / width;
            const scaleY = canvas.height / height;
            
            features.forEach(point => {
                const x = point.x * scaleX;
                const y = point.y * scaleY;
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw title
            ctx.fillStyle = 'blue';
            ctx.font = '14px Arial';
            ctx.fillText(title, 10, 20);
        }

        window.runNormalTest = function() {
            const width = 200;
            const height = 150;
            const imageData = createTestImageData(width, height);
            
            const image = {
                data: imageData,
                width: width,
                height: height,
                scale: 1
            };
            
            const features = extract(image, {top: 0, right: 0, bottom: 0, left: 0});
            
            drawImageWithFeatures('normalCanvas', imageData, width, height, features, `Normal Mode: ${features.length} features`);
            
            document.getElementById('normalResult').textContent = 
                `Extracted ${features.length} features from entire image\n` +
                `All sides: 0% (full image coverage)\n` +
                `First 5 features: ${features.slice(0, 5).map(p => `(${p.x.toFixed(0)}, ${p.y.toFixed(0)})`).join(', ')}`;
        };

        window.runFrameTest = function() {
            const width = 200;
            const height = 150;
            const imageData = createTestImageData(width, height);
            
            const image = {
                data: imageData,
                width: width,
                height: height,
                scale: 1
            };
            
            const features = extract(image, {top: 0.1, right: 0.1, bottom: 0.1, left: 0.1});
            
            drawImageWithFeatures('frameCanvas', imageData, width, height, features, `Uniform Frame: ${features.length} features`);
            
            document.getElementById('frameResult').textContent = 
                `Extracted ${features.length} features from uniform frame\n` +
                `All sides: 10%\n` +
                `Top/Bottom: ${Math.floor(height * 0.1)}px, Left/Right: ${Math.floor(width * 0.1)}px\n` +
                `First 5 features: ${features.slice(0, 5).map(p => `(${p.x.toFixed(0)}, ${p.y.toFixed(0)})`).join(', ')}`;
        };

        window.updateDisplay = function() {
            document.getElementById('topValue').textContent = document.getElementById('topSlider').value;
            document.getElementById('rightValue').textContent = document.getElementById('rightSlider').value;
            document.getElementById('bottomValue').textContent = document.getElementById('bottomSlider').value;
            document.getElementById('leftValue').textContent = document.getElementById('leftSlider').value;
        };

        window.runCustomTest = function() {
            const top = parseFloat(document.getElementById('topSlider').value);
            const right = parseFloat(document.getElementById('rightSlider').value);
            const bottom = parseFloat(document.getElementById('bottomSlider').value);
            const left = parseFloat(document.getElementById('leftSlider').value);
            
            const width = 200;
            const height = 150;
            const imageData = createTestImageData(width, height);
            
            const image = {
                data: imageData,
                width: width,
                height: height,
                scale: 1
            };
            
            const features = extract(image, {top, right, bottom, left});
            
            drawImageWithFeatures('customCanvas', imageData, width, height, features, `Custom Frame: ${features.length} features`);
            
            const topPx = Math.floor(height * top);
            const bottomPx = Math.floor(height * bottom);
            const leftPx = Math.floor(width * left);
            const rightPx = Math.floor(width * right);
            
            document.getElementById('customResult').textContent = 
                `Extracted ${features.length} features from custom frame\n` +
                `Top: ${(top * 100).toFixed(0)}% (${topPx}px), Right: ${(right * 100).toFixed(0)}% (${rightPx}px)\n` +
                `Bottom: ${(bottom * 100).toFixed(0)}% (${bottomPx}px), Left: ${(left * 100).toFixed(0)}% (${leftPx}px)\n` +
                `Inner area excluded: ${width - leftPx - rightPx} × ${height - topPx - bottomPx} pixels\n` +
                `First 5 features: ${features.slice(0, 5).map(p => `(${p.x.toFixed(0)}, ${p.y.toFixed(0)})`).join(', ')}`;
        };

        // Run initial tests
        setTimeout(() => {
            runNormalTest();
            runFrameTest();
            runCustomTest();
        }, 100);
    </script>
</body>
</html>
